# Publish Release
# Publishes npm package and creates GitHub Release when a version tag is pushed
#
# **What it does:**
# 1. Extracts version from tag (e.g., v0.1.1 → 0.1.1)
# 2. Verifies package.json version matches tag version
# 3. Builds the project
# 4. Runs tests
# 5. Publishes to npm (using trusted publishing/OIDC)
# 6. Extracts changelog section for the version
# 7. Creates GitHub Release with changelog
#
# **Triggers:**
# - Tag push matching v*.*.* pattern (automatic, triggered by version-bump.yml)
# - Manual workflow_dispatch (with tag input for re-publishing)
#
# **npm Trusted Publishing Requirements:**
# CRITICAL: This workflow filename (publish-release.yml) MUST exactly match the
# workflow filename configured in npm trusted publisher settings.
#
# Required npm trusted publisher configuration:
# - Organization/User: JSONbored
# - Repository: safemocker (or JSONbored/safemocker)
# - Workflow filename: publish-release.yml (must match this file name exactly)
#
# See: https://docs.npmjs.com/trusted-publishers/
# Documentation: .cursor/npm-trusted-publishing-setup.md
name: Publish Release

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'  # Triggers on version tags (e.g., v0.1.0, v1.2.3)
      - 'v*.*.*'  # Fallback pattern for broader matching
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag name (e.g., v0.1.1)'
        required: true
        type: string

jobs:
  publish-release:
    name: Publish to npm and create GitHub release
    runs-on: ubuntu-latest
    timeout-minutes: 10

    permissions:
      id-token: write  # Required for OIDC (npm trusted publishing)
      contents: write  # Required to create GitHub releases

    steps:
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          # Full history needed for changelog extraction
          fetch-depth: 0
          # For manual trigger, checkout the specified tag; for tag push, use the tag ref
          ref: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.tag || github.ref }}

      - name: Extract version from tag
        id: version
        run: |
          set -e

          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            TAG="${{ github.event.inputs.tag }}"
          else
            TAG="${GITHUB_REF#refs/tags/}"
          fi

          VERSION="${TAG#v}"

          if ! echo "$VERSION" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+$'; then
            echo "❌ Error: Invalid version format '$VERSION' (from tag '$TAG')" >&2
            exit 1
          fi

          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "TAG=$TAG" >> $GITHUB_OUTPUT

      - name: Setup pnpm
        uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: '24'
          registry-url: 'https://registry.npmjs.org'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build project
        run: pnpm build

      - name: Run tests
        run: pnpm test

      - name: Verify package.json version matches tag
        run: |
          set -e

          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          TAG_VERSION="${{ steps.version.outputs.VERSION }}"

          if [ "$PACKAGE_VERSION" != "$TAG_VERSION" ]; then
            echo "❌ Error: package.json version ($PACKAGE_VERSION) does not match tag version ($TAG_VERSION)." >&2
            exit 1
          fi

      - name: Publish to npm
        run: |
          set -e

          VERSION="${{ steps.version.outputs.VERSION }}"

          # Clean up any .npmrc files that might interfere with OIDC
          if [ -n "$NPM_CONFIG_USERCONFIG" ] && [ -f "$NPM_CONFIG_USERCONFIG" ]; then
            if grep -qE "(authToken|_authToken|\$\{NODE_AUTH_TOKEN\})" "$NPM_CONFIG_USERCONFIG"; then
              sed -i '/authToken/d; /\${NODE_AUTH_TOKEN}/d' "$NPM_CONFIG_USERCONFIG" || true
              if [ ! -s "$NPM_CONFIG_USERCONFIG" ]; then
                rm -f "$NPM_CONFIG_USERCONFIG"
              fi
            fi
          fi

          if [ -n "${NODE_AUTH_TOKEN:-}" ]; then
            unset NODE_AUTH_TOKEN
          fi

          if [ -z "$ACTIONS_ID_TOKEN_REQUEST_URL" ] || [ -z "$ACTIONS_ID_TOKEN_REQUEST_TOKEN" ]; then
            echo "❌ Error: OIDC token not available. Check id-token: write permission." >&2
            exit 1
          fi

          # Check if version is already published
          if npm view "@jsonbored/safemocker@$VERSION" version > /dev/null 2>&1; then
            echo "⚠️ Version $VERSION is already published on npm. Skipping publish."
            echo "This is expected when re-running the workflow for an existing version."
          else
            npm publish --access public
            echo "✅ Published @jsonbored/safemocker@$VERSION to npm"
          fi

      - name: Verify npm publish
        run: |
          set -e

          VERSION="${{ steps.version.outputs.VERSION }}"
          sleep 2

          if ! npm view "@jsonbored/safemocker@$VERSION" version > /dev/null 2>&1; then
            echo "⚠️ Warning: Package @jsonbored/safemocker@$VERSION not found on npm"
            echo "This may be expected if the publish step was skipped (version already exists)"
          else
            PUBLISHED_VERSION=$(npm view "@jsonbored/safemocker@$VERSION" version)
            echo "✅ Verified: @jsonbored/safemocker@$PUBLISHED_VERSION is published on npm"
          fi

      - name: Extract changelog for version
        id: changelog
        run: |
          set -e

          VERSION="${{ steps.version.outputs.VERSION }}"

          if [ ! -f CHANGELOG.md ]; then
            echo "No significant changes for this release." > /tmp/release-notes.md
            echo "notes_path=/tmp/release-notes.md" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Extract the version header line (includes date) and content section
          # This ensures idempotency - we use the date from CHANGELOG.md, not current date
          VERSION_HEADER=$(grep -E "^## \[$VERSION\]" CHANGELOG.md | head -1)

          # Extract the version section from CHANGELOG.md using awk
          CHANGELOG_SECTION=$(awk -v version="$VERSION" '
            BEGIN { found=0; in_section=0 }
            /^## \[/ {
              if (found) exit
              if (index($0, "[" version "]") > 0) {
                found=1
                in_section=1
                next
              }
            }
            found && in_section {
              if ($0 ~ /^\[.*\]: /) {
                next
              }
              print
            }
          ' CHANGELOG.md)

          if [ -z "$CHANGELOG_SECTION" ] || [ -z "$(echo "$CHANGELOG_SECTION" | grep -v '^$')" ]; then
            echo "No significant changes for this release." > /tmp/release-notes.md
          else
            {
              # Use the header from CHANGELOG.md if it exists (idempotent), otherwise create one
              if [ -n "$VERSION_HEADER" ]; then
                echo "$VERSION_HEADER"
              else
                echo "## [$VERSION] - $(date +%Y-%m-%d)"
              fi
              echo ""
              echo "$CHANGELOG_SECTION"
            } > /tmp/release-notes.md
          fi

          echo "notes_path=/tmp/release-notes.md" >> $GITHUB_OUTPUT

      - name: Create or Update GitHub Release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2
        with:
          tag_name: ${{ steps.version.outputs.TAG }}
          name: ${{ steps.version.outputs.TAG }}
          body_path: ${{ steps.changelog.outputs.notes_path }}
          generate_release_notes: false
          draft: false
          prerelease: false
          # Idempotent: If release exists, this will update it (make_latest: true ensures it becomes the latest)
          make_latest: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        if: always()
        run: |
          echo "## ✅ Release Published" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** ${{ steps.version.outputs.VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag:** ${{ steps.version.outputs.TAG }}" >> $GITHUB_STEP_SUMMARY
          echo "- **npm Package:** @jsonbored/safemocker@${{ steps.version.outputs.VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **GitHub Release:** [View Release](https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.TAG }})" >> $GITHUB_STEP_SUMMARY

